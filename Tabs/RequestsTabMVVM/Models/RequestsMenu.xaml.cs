using RequestMaster.Databases.MainDatabase;
using RequestMaster.Patterns;
using System.Globalization;
using System.Windows;
using System.Windows.Controls;

namespace RequestMaster.Tabs.RequestsTabMVVM.Models
{
    public partial class RequestsGrid : UserControl
    {
        RequestsContext db;
        RequestsMenuLogger logger;
        Snackbar snackBar;
        string? statusFilter = "активна";
        int? authorFilter;
        public List<Request> requestsList;
        List<Request> searchedRequests = new List<Request>();
        List<Request> requestsToSort = new List<Request>();
        DateTime startDate;
        DateTime endDate;
        public RequestsGrid()
        {
            InitializeComponent();
            logger = new RequestsMenuLogger();
            snackBar = new Snackbar(snackBarXAML);
            db = DatabaseSingleton.CreateInstance();
            helpButton.Focus();
            endDateBox.Text = $"{DateTime.Now:d}";
            startDate = DateTime.ParseExact(startDateBox.Text.ToString(), "dd.MM.yyyy", CultureInfo.InvariantCulture);
            endDate = DateTime.ParseExact(endDateBox.Text.ToString(), "dd.MM.yyyy", CultureInfo.InvariantCulture).AddDays(1).AddSeconds(-1);
            requestsList = db.Requests.
                Where(x => x.CreationDate >= startDate && x.CreationDate <= endDate).ToList();
            requestsDataGrid.ItemsSource = requestsList;
            requestsDataGrid.AutoGeneratedColumns += requestsDataGrid_AutoGeneratedColumns;
        }

        private void requestsDataGrid_AutoGeneratedColumns(object? sender, EventArgs e)
        {
            requestsDataGrid.Columns[0].Header = "ID";
            requestsDataGrid.Columns[1].Header = "описание";
            requestsDataGrid.Columns[2].Header = "номер";
            requestsDataGrid.Columns[3].Header = "статус";
            requestsDataGrid.Columns[4].Visibility = Visibility.Hidden;
            requestsDataGrid.Columns[5].Visibility = Visibility.Hidden;
            requestsDataGrid.Columns[6].Visibility = Visibility.Hidden;
            requestsDataGrid.Columns[7].Visibility = Visibility.Hidden;
            requestsDataGrid.Columns[8].Header = "дата создания";
        }

        private void helpButton_Click(object sender, RoutedEventArgs e)
        {
            snackBar.show("нажмите на любую заявку дважды");
            logger.log($"нажата кнопка помощь");
        }
        private void ClearFiltersButton_Click(object sender, RoutedEventArgs e)
        {
            statusFilter = string.Empty;
            authorFilter = null;
            refreshRequestsDataGridWithoutFilters();

            logger.log($"фильтры очищены");
        }
        private void createRequestButton_Click(object sender, RoutedEventArgs e)
        {
            Requests.createRequestMenu.Visibility = Visibility.Visible;

            logger.log($"нажата кнопка создать заявку");
        }

        private void refreshRequestsDataGridWithoutFilters()
        {
            requestsDataGrid.ItemsSource = requestsList;
            radioButtonStatus_NotImportant.IsChecked = true;
            radioButtonAuthor_NotImportant.IsChecked = true;

            logger.log($"таблица обновлена без фильтров");
        }
        private void requestsDataGrid_MouseDoubleClick(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            try
            {
                Requests.requestCard = requestsList.Where(x => x.RequestID == requestsDataGrid.SelectedIndex + 1).First();
                Requests.requestDetailsMenu.Visibility = Visibility.Visible;

                logger.log($"открыто меню детали заявки №{requestsDataGrid.SelectedIndex + 1}");
            }

            catch (Exception ex) 
            {
                MessageBox.Show(ex.Message);
            }

        }
        private void search_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (!string.IsNullOrEmpty(searchBox.Text))
                {
                    refreshRequestsDataGridWithoutFilters();
                    List<string> searchWords = (searchBox.Text.
                        Split(new[] { ' ', ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                        .Select(word => word.ToLowerInvariant()).ToList());

                    for (int i = 0; i <= requestsList.Count() - 1; ++i)
                    {
                        foreach (string word in searchWords)
                        {
                            if (requestsList[i].Description.ToLowerInvariant().Contains(word))
                            {
                                searchedRequests.Add(requestsList[i]);
                            }
                        }
                    }
                    requestsDataGrid.ItemsSource = searchedRequests;
                }
                else
                {
                    requestsDataGrid.ItemsSource = requestsList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }
        private void SortButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                startDate = DateTime.ParseExact(startDateBox.Text.ToString(), "dd.MM.yyyy", CultureInfo.InvariantCulture);
                endDate = DateTime.ParseExact(endDateBox.Text.ToString(), "dd.MM.yyyy", CultureInfo.InvariantCulture).AddDays(1).AddSeconds(-1);

                if (requestsDataGrid.ItemsSource == searchedRequests)
                {
                    requestsToSort = searchedRequests;
                }
                else
                {
                    requestsToSort = requestsList;
                }

                if (statusFilter != string.Empty && authorFilter != null)
                {
                    requestsDataGrid.ItemsSource = requestsToSort.
                        Where(x => x.Status == statusFilter && x.WhoCreatedID == authorFilter
                        && x.CreationDate >= startDate && x.CreationDate <= endDate);
                }
                if (statusFilter == string.Empty && authorFilter != null)
                {
                    requestsDataGrid.ItemsSource = requestsToSort.
                        Where(x => x.WhoCreatedID == authorFilter
                        && x.CreationDate >= startDate && x.CreationDate <= endDate);
                }
                if (statusFilter != string.Empty && authorFilter == null)
                {
                    requestsDataGrid.ItemsSource = requestsToSort.
                        Where(x => x.Status == statusFilter
                        && x.CreationDate >= startDate && x.CreationDate <= endDate);
                }
                if (statusFilter == string.Empty && authorFilter == null)
                {
                    requestsDataGrid.ItemsSource = requestsToSort.
                        Where(x => x.CreationDate >= startDate && x.CreationDate <= endDate);
                }
            }
            catch (FormatException) 
            {
                snackBar.show("проверьте правильность ввода даты");
            }
            logger.log($"заявки отсортированы");
        }
        private void radioButtonStatus_Active_Checked(object sender, RoutedEventArgs e)
        {
            statusFilter = "активна";
        }

        private void radioButtonStatus_Processing_Checked(object sender, RoutedEventArgs e)
        {
            statusFilter = "в обработке";
        }

        private void radioButtonStatus_Closed_Checked(object sender, RoutedEventArgs e)
        {
            statusFilter = "закрыта";
        }
        private void radioButtonStatus_NotImportant_Checked(object sender, RoutedEventArgs e)
        {
            statusFilter = string.Empty;
        }

        private void radioButtonAuthor_Me_Checked(object sender, RoutedEventArgs e)
        {
            authorFilter = AuthWindow.user!.UserID;
        }
        private void radioButtonAuthor_NotMe_Checked(object sender, RoutedEventArgs e)
        {
            authorFilter = 0;
        }

        private void radioButtonAuthor_NotImportant_Checked(object sender, RoutedEventArgs e)
        {
            authorFilter = null;
        }
    }
}
