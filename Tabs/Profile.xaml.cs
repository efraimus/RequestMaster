using RequestMaster.Databases.MainDatabase;
using RequestMaster.Patterns;
using System.Windows;
using System.Windows.Controls;

namespace RequestMaster.Tabs
{
    public partial class Profile : UserControl 
    {
        RequestsContext db;
        ProfileMenuLogger logger;
        public Profile()
        {
            InitializeComponent();
            logger = new ProfileMenuLogger();
            db = DatabaseSingleton.CreateInstance();
            refreshTab();
            createdRequestsDataGrid.AutoGeneratedColumns += createdRequestsDataGrid_AutoGeneratedColumns;
        }

        private void createdRequestsDataGrid_AutoGeneratedColumns(object? sender, EventArgs e)
        {
            createdRequestsDataGrid.Columns[0].Header = "ID";
            createdRequestsDataGrid.Columns[1].Header = "описание";
            createdRequestsDataGrid.Columns[2].Header = "номер";
            createdRequestsDataGrid.Columns[3].Header = "статус";
            createdRequestsDataGrid.Columns[4].Visibility = Visibility.Hidden;
            createdRequestsDataGrid.Columns[5].Visibility = Visibility.Hidden;
            createdRequestsDataGrid.Columns[6].Visibility = Visibility.Hidden;
        }

        private void refreshButton_Click(object sender, RoutedEventArgs e)
        {
            refreshTab();
        }

        private void refreshTab()
        {
            User user = db.Users.Where(x => x.Login == AuthWindow.login).First();
            textBlockLogin.Text = $"{user.Login}";
            textBlockPassword.Text = $"{user.Password}";
            textBlockEmail.Text = $"{user.Email}";
            textBlockHowManyRequestsCreated.Text = $"{db.Requests.Where(x => x.WhoCreatedID == user.UserID).Count()}";
            textBlockHowManyRequestsClosed.Text = $"{db.Requests.Where(x => x.WhoClosedID == user.UserID).Count()}";
            createdRequestsDataGrid.ItemsSource = db.Requests.Where(x => x.WhoCreatedID == AuthWindow.user!.UserID).ToList();
            logger.log($"вкладка обновлена");
        }
    }
}